<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>Spotify Website Tests</title>
        <meta name="description" content="A dumb website for my spotify tests.">
        <meta name="author" content="Backback12">

        <link rel="icon" href="favicon.ico">

        <script src="lib/jquery-1.11.1.min.js"></script>
        <script src="lib/underscore-min.js"></script>
        <script src="lib/bootstrap.min.js"></script>
        <script src="config.js"></script>

    </head>
    <body>
        <h1>Spoopify Test</h1>
        <p>This is the spotify test website.</p>
        
        <p>
            <a id=ResetButton href="http://127.0.0.1:5500/web/index.html"><button>Reset</button></a>
            <button onclick="authorizeUser()" id='AuthButton'>Authorize User</button>



            <button onclick='getSpotify("https\:\/\/api.spotify.com/v1/me")'>User Info</button>
            <button onclick='getSpotify("https\:\/\/api.spotify.com/v1/me/top/tracks?limit=3")'>Top Tracks</button>
        </p> 
        </p>
            <textarea id='OutputTextArea' rows="30" cols="100" wrap="soft">Output</textarea>
        </p>
    </body>

    <script>
"use strict";
var accessToken = null;
var curUserID = null;

function authorizeUser() {
    //var scopes = 'playlist-read-private playlist-modify-private playlist-modify-public';
    const scopesList = ['ugc-image-upload',
                'user-read-recently-played',
                'user-top-read',
                'user-read-playback-position',
                'user-read-playback-state',
                'user-modify-playback-state',
                'user-read-currently-playing',
                'app-remote-control',
                'streaming',
                'playlist-modify-public',
                'playlist-modify-private',
                'playlist-read-private',
                'playlist-read-collaborative',
                'user-follow-modify',
                'user-follow-read',
                'user-library-modify',
                'user-library-read',
                'user-read-email',
                'user-read-private'];
    var scopes = scopesList.join(' ');
    //var scopes = string.concat()

    var url = 'https://accounts.spotify.com/authorize?client_id=' + SPOTIFY_CLIENT_ID +
        '&response_type=token' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
    document.location = url;
}

function parseArgs() {
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function fetchCurrentUserProfile(callback) {
    var url = 'https://api.spotify.com/v1/me';
    getSpotify(url, null, callback);
}

function getSpotify(url, data=null, callback=sendOutput) {
    $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + accessToken
        },
        success: function(r) {
            callback(r);
        },
        error: function(r) {
            callback(null);
        }
    });
}

function sendOutput(text) {
    document.getElementById('OutputTextArea').innerHTML = JSON.stringify(text, null, 3)
}

$(document).ready(

    function() {
        //songTable = initTable();
        var args = parseArgs();


        if ('error' in args) {
            error("Sorry, I can't read your playlists from Spotify without authorization");
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
        } else if ('access_token' in args) {
            // USER IS AUTHENTICATED

            accessToken = args['access_token'];
            $(".worker").hide();
            fetchCurrentUserProfile(function(user) {
                if (user) {
                    curUserID = user.id;
                    $("#who").text(user.id);
                    //loadPlaylists(user.id);
                } else {
                    error("Trouble getting the user profile");
                }
            });
            
            // hide auth button
            document.getElementById('AuthButton').style.display = 'none';

            alert("you've been authenticated")
        } else {
            // USER NOT YET AUTHENTICATED
            /*
            $("#go").show();
            $("#go").on('click', function() {
                authorizeUser();
            });
            */
        }
        /*
        $("#save,#dropSave").on('click', function() {
            savePlaylist(curPlaylist, true);
        });
        $("#dropOverwrite").on('click', function() {
            savePlaylist(curPlaylist, false);
        });

        $("#pick").on('click', function() {
            showPlaylists();
        });

        $.fn.dataTable.ext.search.push(playlistFilter);
        $('#min-bpm,#max-bpm,#include-double').on('keyup change', function() {
            songTable.draw();
            updateSaveButtonState();
        });
        */
    }
);

</script>
</html>